<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Emotion Music Recommendation</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark Theme Variables */
      --color-primary: #1DB954; /* Spotify Green */
      --color-primary-dark: #168a3f;
      --color-secondary: #00bcd4;
      --color-bg-dark: #121212; /* Very dark background */
      --color-card-dark: #1E1E1E; /* Slightly lighter card background */
      --color-text-light: #E0E0E0;
      --color-text-muted: #A0A0A0;
      --color-border: #333333;
    }

    body {
      background-color: var(--color-bg-dark);
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      color: var(--color-text-light);
    }

    h1, h2 {
      font-family: 'Montserrat', sans-serif;
    }

    h1 {
      font-weight: 700;
      color: var(--color-primary);
      text-align: center;
      margin-bottom: 50px;
      font-size: 3rem;
      letter-spacing: 1px;
      /* text-shadow: 0 0 10px rgba(29, 185, 84, 0.4); */
    }

    h2 {
      color: var(--color-text-light);
      font-weight: 600;
      font-size: 1.6rem;
      margin-bottom: 25px;
      border-left: 4px solid var(--color-primary);
      padding-left: 15px;
    }

    .container-fluid {
      padding: 50px 30px;
    }

    .section {
      background-color: var(--color-card-dark);
      padding: 35px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); /* Stronger shadow for dark theme depth */
      border: 1px solid var(--color-border);
      height: 100%; /* Ensure sections match height */
    }

    .video-section img {
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
      max-height: 400px;
      width: 100%;
      object-fit: cover;
      border: 2px solid var(--color-primary-dark);
    }

    /* Table Styling */
    table {
      font-size: 0.95rem;
      margin-top: 15px;
      border-radius: 8px;
      overflow: hidden; /* Important for border-radius on table */
    }

    .table-dark-custom {
      --bs-table-bg: #282828;
      --bs-table-color: var(--color-text-light);
      --bs-table-border-color: #383838;
      --bs-table-hover-bg: #343434;
    }

    .table-dark-custom th {
      background-color: var(--color-primary-dark);
      color: #ffffff;
      font-weight: 600;
    }

    .table-dark-custom td, .table-dark-custom th {
      text-align: center;
      vertical-align: middle;
      color: var(--color-text-muted); /* default muted color for rows */
    }

    /* -------------------------
       CORRECTED HOVER RULES
       -------------------------
       - Strong specificity so it wins.
       - Changes both cell text and links inside to white.
       - Uses a subtle accent background for hover (not full green).
    */
    .panel .table-dark-custom.table-hover tbody tr:hover td,
    .panel .table-dark-custom.table-hover tbody tr:hover td a {
      background-color: rgba(29,185,84,0.08) !important; /* subtle accent */
      color: #ffffff !important; /* ensure readability */
    }

    /* Keep header color stable (not affected by hover on tbody) */
    .table-dark-custom thead th {
      color: #ffffff !important;
      background-color: var(--color-primary-dark) !important;
    }

    /* If your cells contain anchors, make sure visited/active links are visible too */
    .panel .table-dark-custom.table-hover tbody tr:hover td a:link,
    .panel .table-dark-custom.table-hover tbody tr:hover td a:visited,
    .panel .table-dark-custom.table-hover tbody tr:hover td a:hover,
    .panel .table-dark-custom.table-hover tbody tr:hover td a:active {
      color: #ffffff !important;
      text-decoration: none;
    }

    /* Responsive Columns */
    .row-cols-custom {
      display: flex;
      flex-wrap: wrap; /* Allows wrapping on small screens */
      gap: 30px;
    }

    @media (min-width: 768px) {
      .row-cols-custom {
        flex-direction: row;
      }
      .col-custom {
        flex: 1;
        min-width: 45%; /* Better distribution */
      }
    }

    /* New UI helpers */
    #mode-controls {
      position: fixed;
      right: 25px;
      top: 25px;
      z-index: 1100;
      display: flex;
      gap: 10px;
    }

    /* =========================
       EMOJI SECTION STYLES ONLY
       (Everything else unchanged)
       ========================= */

    /* container that holds emoji buttons inside the card */
    #emoji-container {
      padding: 18px;
      background: var(--color-bg-dark);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: center;
      justify-content: center;
    }

    /* layout for emoji items */
    #emoji-selector {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
      width: 100%;
    }

    /* upgraded emoji button: circular card with label */
    .emoji-btn {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      cursor: pointer;
      border: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      width: 84px;
      height: 84px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
      border: 1px solid rgba(255,255,255,0.03);
      color: var(--color-text-light);
      font-weight: 600;
      outline: none;
    }

    .emoji-btn .emoji-icon {
      font-size: 28px;
      width: 46px;
      height: 46px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:10px;
      background: linear-gradient(135deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      box-shadow: inset 0 -6px 12px rgba(0,0,0,0.12);
    }

    .emoji-btn .emoji-label {
      font-size: 12px;
      color: var(--color-text-muted);
      margin-top: 2px;
    }

    .emoji-btn:hover,
    .emoji-btn:focus {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 18px 40px rgba(0,0,0,0.7);
      border-color: rgba(29,185,84,0.12);
    }

    /* selected state (applies when clicked) */
    .emoji-btn.selected {
      background: linear-gradient(180deg, rgba(29,185,84,0.06), rgba(255,255,255,0.01));
      border: 1px solid rgba(29,185,84,0.18);
      box-shadow: 0 20px 48px rgba(29,185,84,0.08);
      transform: translateY(-6px) scale(1.02);
    }

    /* small responsive */
    @media (max-width: 575px) {
      #mode-controls { right: 15px; top: 15px; gap: 8px; }
      h1 { font-size: 2.2rem; margin-bottom: 30px;}
      .section { padding: 25px; }
      #emoji-selector { flex-wrap: wrap; justify-content: center; }
      .emoji-btn { width: 72px; height:72px; }
      .emoji-btn .emoji-icon { font-size: 24px; width:40px; height:40px; }
    }

    /* =========================
       END EMOJI SECTION STYLES
       ========================= */

    .emoji-btn:focus { box-shadow: 0 12px 30px rgba(29,185,84,0.10); }

    .btn-mode { 
      padding: 10px 15px; 
      border-radius: 8px; 
      font-weight: 500;
    }

    /* Override Bootstrap primary/success for dark theme */
    .btn-outline-success {
      --bs-btn-color: var(--color-primary);
      --bs-btn-border-color: var(--color-primary);
      --bs-btn-hover-bg: var(--color-primary-dark);
      --bs-btn-hover-border-color: var(--color-primary-dark);
      --bs-btn-hover-color: #ffffff;
      --bs-btn-active-bg: var(--color-primary);
      --bs-btn-active-border-color: var(--color-primary);
    }
    
    .btn-success {
      --bs-btn-bg: var(--color-primary);
      --bs-btn-border-color: var(--color-primary);
      --bs-btn-hover-bg: var(--color-primary-dark);
      --bs-btn-hover-border-color: var(--color-primary-dark);
    }

    .active-mode { 
      /* box-shadow: 0 0 15px rgba(29, 185, 84, 0.6);  */
      transform: translateY(-1px);
    }

    .status-badge {
      display: inline-block;
      margin-left: 10px;
      font-size: 0.8rem;
      color: var(--color-bg-dark);
      background: var(--color-primary);
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 700;
    }

    /* Camera/Emoji specific styling (unchanged) */
    .video-wrap { 
      min-height: 300px; 
      display:flex; 
      align-items:center; 
      justify-content:center; 
      background: var(--color-bg-dark);
      border-radius: 8px;
    }
    
    /* Capture controls */
    #capture-controls {
        padding-top: 15px;
    }
    
    #capture-msg {
        color: var(--color-primary) !important;
        font-weight: 600;
    }
    
    #camera-error {
        color: #ff5722 !important; /* Orange/Red for error */
        font-weight: 500;
    }

    /* general responsive tweaks */
    @media (max-width: 575px) {
      #emoji-selector { gap: 10px; }
    }
  </style>
</head>

<body>
  <div id="mode-controls" aria-hidden="false">
    <button id="mode-camera" class="btn btn-outline-success btn-mode">Camera</button>
    <button id="mode-emoji" class="btn btn-outline-primary btn-mode">Emoji</button>
  </div>

  <div class="container-fluid">
    <h1>üéµ Emotion Music Recommender üé∂</h1>

    <div class="row-cols-custom">
      <div class="section col-custom text-center">
        <h2>üëÅÔ∏è Emotion Input <span id="modeBadge" class="status-badge">Emoji</span></h2>

        <div id="video-container" class="video-wrap" style="display: none;">
          <img id="video-stream" src="/video_feed" alt="Video Feed" onerror="handleStreamError()" />
        </div>

        <!-- Updated emoji container (only this section changed) -->
        <div id="emoji-container" style="display: none;">
          <p class="text-muted">Select an emotion (or switch to Camera mode) to get recommendations:</p>
          <div id="emoji-selector" role="list">
            <button class="emoji-btn" data-emoji="üòÑ" title="Happy" aria-label="Happy">
              <div class="emoji-icon">üòÑ</div>
              <div class="emoji-label">Happy</div>
            </button>
            <button class="emoji-btn" data-emoji="üò¢" title="Sad" aria-label="Sad">
              <div class="emoji-icon">üò¢</div>
              <div class="emoji-label">Sad</div>
            </button>
            <button class="emoji-btn" data-emoji="üò°" title="Angry" aria-label="Angry">
              <div class="emoji-icon">üò°</div>
              <div class="emoji-label">Angry</div>
            </button>
            <button class="emoji-btn" data-emoji="üòê" title="Neutral" aria-label="Neutral">
              <div class="emoji-icon">üòê</div>
              <div class="emoji-label">Neutral</div>
            </button>
            <button class="emoji-btn" data-emoji="üò≤" title="Surprised" aria-label="Surprised">
              <div class="emoji-icon">üò≤</div>
              <div class="emoji-label">Surprised</div>
            </button>
          </div>
        </div>

        <div id="camera-error" class="mt-3" style="display:none;">
          Camera not available on this server.
        </div>

        <div id="capture-controls" class="mt-4" style="display:none; justify-content:center; gap:10px;">
          <button id="btn-capture" class="btn btn-success">üì∏ Capture Emotion</button>
          <button id="btn-recapture" class="btn btn-outline-secondary" style="display:none;">üîÅ Re-capture</button>
          <span id="capture-msg" class="ms-2" style="display:none;">Captured!</span>
        </div>

        <div id="capture-preview" style="margin-top:20px; display:none; text-align:center;">
          <p class="text-muted" style="font-size:0.9rem; margin-bottom:10px;">Emotion Snapshot</p>
          <img id="captured-img" src="" alt="Captured face" style="max-width:260px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.3);" />
        </div>
      </div>

      <div class="section col-custom">
        <h2>üé∂ Recommended Tracks</h2>
        <div id="ResultArea">
          </div>
      </div>
    </div>
  </div>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script type="text/javascript">
    // The existing JavaScript logic is copied here, unchanged except
    // for a small addition to the emoji handler to toggle the selected class
    // and keyboard accessibility for emoji buttons.
    
    // initial mode from server if provided; fallback to 'emoji'
    var initialMode = "{{ current_mode | default('emoji') }}";
    if (!initialMode || initialMode === "{{ current_mode | default('emoji') }}") {
      // safe fallback in case Jinja didn't render (e.g. static preview)
      initialMode = 'emoji';
    }

    var pollTimer = null;
    var pollIntervalMs = 800; // camera mode poll interval

    function setModeUI(mode) {
      if (mode === 'camera') {
        $('#video-container').show();
        $('#emoji-container').hide();
        $('#modeBadge').text('Camera');
        $('#mode-camera').addClass('active-mode');
        $('#mode-emoji').removeClass('active-mode');
        $('#capture-controls').show(); // show capture controls when camera active
      } else {
        $('#video-container').hide();
        $('#emoji-container').show();
        $('#modeBadge').text('Emoji');
        $('#mode-emoji').addClass('active-mode');
        $('#mode-camera').removeClass('active-mode');
        $('#capture-controls').hide();
        // hide captured preview if present when switching to emoji
        $('#capture-preview').hide();
        $('#btn-recapture').hide();
        $('#capture-msg').hide();
      }
    }

    function startPolling() {
      stopPolling();
      pollTimer = setInterval(function () {
        refreshRecs();
      }, pollIntervalMs);
    }

    function stopPolling() {
      if (pollTimer) {
        clearInterval(pollTimer);
        pollTimer = null;
      }
    }

    function refreshRecs() {
      // prefer /get_recs; fallback to /t
      var recsUrl = '/get_recs';
      $.getJSON(recsUrl).done(function (data) {
        renderTable(data);
      }).fail(function () {
        // fallback to legacy /t
        $.getJSON('/t', function (data) {
          renderTable(data);
        });
      });
    }

    function renderTable(data) {
      // data is an array of objects {Name, Album, Artist}
      $("#ResultArea").html("");
      // *** MODIFIED: Using the existing dark table rendering (unchanged) ***
      var table = $("<table class='table table-dark-custom table-hover table-bordered table-sm'></table>").appendTo("#ResultArea");
      var thead = $("<thead></thead>").appendTo(table);
      var rowHeader = $("<tr></tr>").appendTo(thead);
      $("<th></th>").text("Name").appendTo(rowHeader);
      $("<th></th>").text("Album").appendTo(rowHeader);
      $("<th></th>").text("Artist").appendTo(rowHeader);

      var tbody = $("<tbody></tbody>").appendTo(table);

      if (!Array.isArray(data) || data.length === 0) {
        var trEmpty = $("<tr></tr>").appendTo(tbody);
        $("<td colspan='3'>No recommendations found</td>").appendTo(trEmpty);
        return;
      }

      data.forEach(function (value) {
        var tr = $("<tr></tr>").appendTo(tbody);
        $("<td></td>").text(value.Name || "").appendTo(tr);
        $("<td></td>").text(value.Album || "").appendTo(tr);
        $("<td></td>").text(value.Artist || "").appendTo(tr);
      });
    }

    // Mode control handlers
    $('#mode-camera').on('click', function () {
      // request server switch to camera mode
      $.ajax({
        url: '/set_mode',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ mode: 'camera' })
      }).done(function (resp) {
        // if server says OK, show camera UI
        if (resp && resp.status === 'ok') {
          setModeUI('camera');
          // show video stream
          $('#video-stream').attr('src', '/video_feed');
          $('#camera-error').hide();
          startPolling(); // poll recs while camera active
        } else {
          // show error if camera unavailable or server responded with error
          $('#camera-error').show().text((resp && resp.message) ? resp.message : 'Camera not available');
          setModeUI('emoji');
          stopPolling();
        }
      }).fail(function (xhr) {
        // fallback: still attempt to show camera (server might not implement /set_mode)
        // try showing stream; if it fails the image onerror handler will show error
        setModeUI('camera');
        $('#video-stream').attr('src', '/video_feed');
        startPolling();
      });
    });

    $('#mode-emoji').on('click', function () {
      $.ajax({
        url: '/set_mode',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ mode: 'emoji' })
      }).always(function () {
        // clear src first to stop browser from fetching stream
        $('#video-stream').attr('src', '');
        setModeUI('emoji');
        stopPolling();
        // fetch current recommended list for emoji mode (server will use last chosen emoji or default)
        refreshRecs();
      });
    });

    // Emoji buttons: set emoji and update table
    // ADDITION: toggle visual 'selected' state and keyboard support (Enter/Space)
    $(document).on('click', '.emoji-btn', function () {
      var emoji = $(this).data('emoji');

      // visual selection
      $('.emoji-btn').removeClass('selected');
      $(this).addClass('selected');

      $.ajax({
        url: '/set_emoji',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ emoji: emoji })
      }).done(function (resp) {
        if (resp && resp.status === 'ok') {
          // resp.data contains song list ‚Äî refresh UI
          renderTable(resp.data || []);
        } else {
          // fallback to polling refresh
          refreshRecs();
        }
      }).fail(function () {
        // fallback
        refreshRecs();
      });
    });

    // keyboard accessibility: Enter/Space selects emoji
    $(document).on('keydown', '.emoji-btn', function (e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        $(this).trigger('click');
      }
    });

    // Capture button logic (one-shot capture)
    $('#btn-capture').on('click', function () {
      // disable capture button to avoid duplicate calls
      $('#btn-capture').prop('disabled', true).text('Capturing...');
      $('#capture-msg').hide();
      $('#capture-preview').hide();
      $('#btn-recapture').hide();

      $.ajax({
        url: '/capture_face',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}) // no payload needed
      }).done(function (resp) {
        if (resp && resp.status === 'ok') {
          // show captured image
          if (resp.image) {
            $('#captured-img').attr('src', resp.image);
            $('#capture-preview').show();
          }
          // update table from resp.data
          if (Array.isArray(resp.data)) {
            renderTable(resp.data);
          } else {
            refreshRecs();
          }
          $('#capture-msg').show().text('Captured! Showing recommendations.');
          $('#btn-recapture').show();
        } else {
          alert('Capture failed: ' + (resp && resp.message ? resp.message : 'unknown error'));
        }
      }).fail(function (xhr) {
        alert('Capture request failed. Is the camera available on the server?');
      }).always(function () {
        $('#btn-capture').prop('disabled', false).text('üì∏ Capture Emotion');
      });
    });

  // Re-capture button: start camera and reset preview so user can capture again
$('#btn-recapture').off('click').on('click', function () {
  // Call server to recreate a fresh camera instance
  $.ajax({
    url: '/set_mode',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify({ mode: 'camera' })
  }).done(function (resp) {
    if (resp && resp.status === 'ok') {
      // Hide preview & UI reset
      $('#capture-preview').hide();
      $('#capture-msg').hide();
      $('#btn-recapture').hide();
      $('#captured-img').attr('src', '');

      // Ensure UI shows camera controls
      setModeUI('camera');

      // Force the browser to open a NEW connection to the streaming endpoint.
      // Append a timestamp query to bust caches and guarantee a fresh multipart response.
      var newSrc = '/video_feed?ts=' + Date.now();
      $('#video-stream').attr('src', newSrc);

      // Small delay to allow the server to initialize camera thread; then start polling.
      // If you want it faster, reduce timeout to 50ms; 120-200ms is conservative.
      setTimeout(function () {
        $('#camera-error').hide();
        startPolling();
      }, 150);

    } else {
      var msg = (resp && resp.message) ? resp.message : 'Cannot start camera';
      alert(msg);
    }
  }).fail(function (xhr) {
    alert('Failed to start camera. Check server logs.');
  });
});


    // handle broken stream gracefully
    function handleStreamError() {
      $('#camera-error').show().text('Video stream not available (server may not support camera or is busy).');
      setModeUI('emoji');
      stopPolling();
      refreshRecs();
    }

    // initial setup on page load
    $(function () {
      // decide initial UI based on server-sent initialMode variable
      var mode = initialMode || 'emoji';
      if (mode === 'camera') {
        $('#video-stream').attr('src', '/video_feed');
        setModeUI('camera');
        startPolling();
      } else {
        setModeUI('emoji');
        stopPolling();
      }
      // load initial recommendations
      refreshRecs();
    });

    // Optional: reload table every 8s when in emoji mode to pick up external changes
    setInterval(function () {
      if ($('#emoji-container').is(':visible')) refreshRecs();
    }, 8000);
  </script>
</body>

</html>
